<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calendario Lunare</title>

<style>
:root {
    --bg: #0b0f1a;
    --card: #151a2c;
    --text: #ffffff;
}

[data-theme="light"] {
    --bg: #f4f6fb;
    --card: #ffffff;
    --text: #111;
}

body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
}

select {
    padding: 0.4rem;
    border-radius: 6px;
}

.container {
    max-width: 900px;
    margin: auto;
    padding: 1rem;
}

.today {
    text-align: center;
    margin-bottom: 2rem;
}

.today-date {
    font-size: 1rem;
    opacity: 0.8;
    margin-bottom: 0.5rem;
}

svg {
    width: 150px;
    height: 150px;
}

.fase {
    font-size: 1.3rem;
    font-weight: bold;
}

.info {
    opacity: 0.8;
    font-size: 0.9rem;
}

.month-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1.5rem 0 0.5rem;
}

.month-nav button {
    background: var(--card);
    border: none;
    color: var(--text);
    padding: 0.5rem 0.8rem;
    border-radius: 8px;
    font-size: 1rem;
}

.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.4rem;
}

.day, .header {
    background: var(--card);
    padding: 0.5rem;
    border-radius: 8px;
    text-align: center;
    font-size: 0.85rem;
}

.header {
    font-weight: bold;
    opacity: 0.7;
}

.today-cell {
    outline: 2px solid #6aa7ff;
}

/* Evidenziazioni */
.full-moon {
    box-shadow: 0 0 14px rgba(255,255,255,0.45);
}

.new-moon {
    background: linear-gradient(135deg, #0006, #0003);
}

@media (max-width: 600px) {
    svg {
        width: 120px;
        height: 120px;
    }
}
</style>
</head>

<body>

<header>
    <strong>ðŸŒ™ Luna</strong>
    <select id="theme">
        <option value="system">Sistema</option>
        <option value="dark">Scuro</option>
        <option value="light">Chiaro</option>
    </select>
</header>

<div class="container">

    <div class="today">
        <div class="today-date" id="today-date"></div>

        <svg viewBox="-100 -100 200 200">
            <defs>
                <clipPath id="moon-clip">
                    <circle r="80"/>
                </clipPath>

                <linearGradient id="shadow-gradient"
                    x1="0%" y1="0%" x2="100%" y2="0%"
                    gradientUnits="userSpaceOnUse">

                    <!-- ombra profonda -->
                    <stop offset="0%" stop-color="#000" stop-opacity="0.88"/>

                    <!-- quasi tutta ombra -->
                    <stop offset="65%" stop-color="#000" stop-opacity="0.9"/>

                    <!-- terminatore stretto -->
                    <stop offset="72%" stop-color="#000" stop-opacity="0.7"/>

                    <!-- luce -->
                    <stop offset="100%" stop-color="#000" stop-opacity="0"/>
                </linearGradient>

            </defs>

            <image href="luna.png"
                   x="-80" y="-80"
                   width="160" height="160"
                   clip-path="url(#moon-clip)" />

            <circle id="shadow"
                r="80"
                fill="#000"
                opacity="0.85"
                clip-path="url(#moon-clip)" />

        </svg>

        <div class="fase" id="fase"></div>
        <div class="info" id="info"></div>
    </div>

    <div class="month-nav">
        <button id="prev">â—€</button>
        <strong id="month-label"></strong>
        <button id="next">â–¶</button>
    </div>

    <div class="calendar" id="calendar"></div>

</div>

<script>
/* ---------- TEMA ---------- */
const themeSelect = document.getElementById("theme");

function applyTheme(value) {
    if (value === "system") {
        document.documentElement.removeAttribute("data-theme");
    } else {
        document.documentElement.setAttribute("data-theme", value);
    }
    localStorage.setItem("theme", value);
}

themeSelect.value = localStorage.getItem("theme") || "system";
applyTheme(themeSelect.value);
themeSelect.addEventListener("change", e => applyTheme(e.target.value));

/* ---------- LUNA ---------- */
const lp = 2551443;
const newMoon = new Date('2000-01-06T18:14:00Z').getTime();

function moonPhase(date) {
    return (((date.getTime() - newMoon) / 1000) % lp) / lp;
}

function faseNome(p) {
    if (p < 0.03 || p > 0.97) return "Luna Nuova";
    if (p < 0.22) return "Luna Crescente";
    if (p < 0.28) return "Primo Quarto";
    if (p < 0.47) return "Gibbosa Crescente";
    if (p < 0.53) return "Luna Piena";
    if (p < 0.72) return "Gibbosa Calante";
    if (p < 0.78) return "Ultimo Quarto";
    return "Luna Calante";
}

function faseEmoji(p) {
    if (p < 0.03 || p > 0.97) return "ðŸŒ‘";
    if (p < 0.22) return "ðŸŒ’";
    if (p < 0.28) return "ðŸŒ“";
    if (p < 0.47) return "ðŸŒ”";
    if (p < 0.53) return "ðŸŒ•";
    if (p < 0.72) return "ðŸŒ–";
    if (p < 0.78) return "ðŸŒ—";
    return "ðŸŒ˜";
}

function updateToday() {
    const now = new Date();
    const p = moonPhase(now);

    const illumFrac = (1 - Math.cos(2 * Math.PI * p)) / 2;
    const illum = Math.round(illumFrac * 100);

    const shadow = document.getElementById("shadow");

    // distanza del cerchio dell'ombra dal centro (curvatura)
    const d = (1 - illumFrac) * 80; // 80 = raggio della luna
    const x = p < 0.5 ? d : -d;

    // aggiorna posizione cerchio ombra
    shadow.setAttribute("cx", x);
    shadow.setAttribute("cy", 0);

document
  .getElementById("shadow-gradient")
  .setAttribute(
    "gradientTransform",
    `translate(${shift},0)`
  );

    document.getElementById("fase").textContent = faseNome(p);
    document.getElementById("info").textContent = `Illuminazione: ${illum}%`;

    document.getElementById("today-date").textContent =
        now.toLocaleDateString("it-IT", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric"
        });
}

/* ---------- CALENDARIO ---------- */
let current = new Date();

function buildCalendar() {
    const cal = document.getElementById("calendar");
    const label = document.getElementById("month-label");
    cal.innerHTML = "";

    const year = current.getFullYear();
    const month = current.getMonth();
    const today = new Date();

    label.textContent = current.toLocaleDateString("it-IT", {
        month: "long",
        year: "numeric"
    });

    ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"].forEach(h => {
        const d = document.createElement("div");
        d.className = "header";
        d.textContent = h;
        cal.appendChild(d);
    });

    let firstDay = new Date(year, month, 1).getDay();
    firstDay = (firstDay + 6) % 7; // Lun = 0

    for (let i = 0; i < firstDay; i++)
        cal.appendChild(document.createElement("div"));

    const days = new Date(year, month + 1, 0).getDate();

    for (let d = 1; d <= days; d++) {
        const date = new Date(year, month, d);
        const p = moonPhase(date);

        const cell = document.createElement("div");
        cell.className = "day";

        if (
            d === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
        ) cell.classList.add("today-cell");

        if (p < 0.03 || p > 0.97) cell.classList.add("new-moon");
        if (p > 0.47 && p < 0.53) cell.classList.add("full-moon");

        cell.innerHTML = `<strong>${d}</strong><br>${faseEmoji(p)}`;
        cal.appendChild(cell);
    }
}

document.getElementById("prev").onclick = () => {
    current.setMonth(current.getMonth() - 1);
    buildCalendar();
};

document.getElementById("next").onclick = () => {
    current.setMonth(current.getMonth() + 1);
    buildCalendar();
};

updateToday();
buildCalendar();
</script>

</body>
</html>
